<!DOCTYPE html>
<html>
<head>
    <meta charset="UTF-8">
    <link rel="stylesheet" href="style.css">
    <!-- <link rel="preload" href="led.ttf" as="font" type="font/ttf" /> -->
    <title>TheSlide</title>
</head>

<body>

<div class="font_preload" style="opacity: 0">
    <span style="font-family: 'led';">...</span>
</div>

    <div id="middle">
        <canvas id="mycanvas" width="500" height="500"></canvas>
    </div>
    
<script type="module">
function truncateDecimals(number, digits) {
    var multiplier = Math.pow(10, digits),
        adjustedNum = number * multiplier,
        truncatedNum = Math[adjustedNum < 0 ? 'ceil' : 'floor'](adjustedNum);
    return truncatedNum / multiplier;
};
function numberWithSpaces(x) {
    return x.toString().replace(/\B(?=(\d{3})+(?!\d))/g, " ");
}

//============================  BLOCKCHAIN STATE  ====================================
function blockchain_state() {
    fetch("https://api.coinset.org/get_blockchain_state", {
      method: "POST",
      headers: { "Content-Type": "application/json", },
      body: JSON.stringify({}),
    })
    .then((response) => {
        if (!response.ok) {
            throw new Error(`HTTP error! Status: ${response.status}`);
        }
    return response.json();
    })
    .then((data) => {
        BLOCK.height1 = BLOCK.height2;
        BLOCK.spi1 = BLOCK.spi2;
        BLOCK.abt1 = BLOCK.abt2;
        BLOCK.dif1 = BLOCK.dif2;
        BLOCK.msize1 = BLOCK.msize2;
        BLOCK.mcost1 = BLOCK.mcost2;
        BLOCK.mfees1 = BLOCK.mfees2;
        BLOCK.space1 = BLOCK.space2;

        ABT = data.blockchain_state.average_block_time + " sec";
        DIF = data.blockchain_state.difficulty;
        MEMFEES = data.blockchain_state.mempool_fees;
        MEMCOST = data.blockchain_state.mempool_cost;
        MEMSIZE = data.blockchain_state.mempool_size;
        DEF = data.blockchain_state.peak.deficit;
        HEIGHT = data.blockchain_state.peak.height;
        OVERF = data.blockchain_state.peak.overflow;
        RITER = data.blockchain_state.peak.required_iters;
        SPI = data.blockchain_state.peak.signage_point_index + "/64";
        SSITERS = data.blockchain_state.peak.sub_slot_iters;
        WEIGHT = data.blockchain_state.peak.weight;
        SPACE = data.blockchain_state.space;
        HEADER = data.blockchain_state.peak.header_hash;

        BLOCK.height2 = HEIGHT;
        BLOCK.spi2 = SPI;
        BLOCK.abt2 = ABT;
        BLOCK.dif2 = DIF;
        BLOCK.msize2 = MEMSIZE;
        BLOCK.mcost2 = MEMCOST;
        BLOCK.mfees2 = MEMFEES;
        BLOCK.space2 = SPACE;


        BLOCK.x2 = canvas.width;
        raf = window.requestAnimationFrame(animate);
    })
    .catch((error) => {
        console.error('Fetch error:', error);
    });
};

function animate() {
  if ( BLOCK.x2 > w/10 ) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    ctx.fillStyle = "black";
    ctx.fillRect(0, 0, canvas.width, canvas.height);

    raf = window.requestAnimationFrame(animate);

    BLOCK.x2 += BLOCK.vx;
    BLOCK.x1 += BLOCK.vx;
    BLOCK.hue += 1;
    
    BLOCK.drawtext();
  } else {
    window.cancelAnimationFrame(raf);
    BLOCK.x2 = canvas.width;
    BLOCK.x1 = w/10;
  }
};

//============================  INIT  ====================================
var ABT;
var DIF;
var MEMFEES;
var MEMSIZE;
var DEF;
var HEIGHT;
var OVERF;
var RITER;
var SPI;
var SSITERS;
var TITERS;
var WEIGHT;
var SPACE;
var MEMCOST;
var HEADER;

var canvas = document.getElementById("mycanvas");
var ctx = canvas.getContext("2d");
var w = document.getElementById("middle").clientWidth;
var h = document.getElementById("middle").clientHeight;

ctx.canvas.width = w;
ctx.canvas.height = h;
console.log("w - h : " + w + "-" + h)

//ctx.font = "40px led";

let raf;

const BLOCK = {
  x1: w/10,
  y1: h/20,
  x2: 1000,
  vx: -20,
  hue: 60,
  height1: 0,
  height2: 0,
  spi1: 0,
  spi2: 0,
  abt1: 0,
  abt2: 0,
  dif1: 0,
  dif2: 0,
  msize1: 0,
  msize2: 0,
  mcost1: 0,
  mcost2: 0,
  mfees1: 0,
  mfees2: 0,
  space1: 0,
  space2: 0,
drawtext() {
    //ctx.fillStyle = "green";HSL(120,100,50)
    ctx.fillStyle = "HSL(" + this.hue % 360 + ",100%,50%)";
    ctx.fillText("BLOCK HEIGHT", this.x1, 3*this.y1);
    ctx.fillText("BLOCK HEIGHT", this.x2, 3*this.y1);
    ctx.fillText("SIGNAGE POINT INDEX", this.x1, 5*this.y1);
    ctx.fillText("SIGNAGE POINT INDEX", this.x2, 5*this.y1);
    ctx.fillText("AVERAGE BLOCK TIME", this.x1, 7*this.y1);
    ctx.fillText("AVERAGE BLOCK TIME", this.x2, 7*this.y1);
    ctx.fillText("DIFFICULTY", this.x1, 9*this.y1);
    ctx.fillText("DIFFICULTY", this.x2, 9*this.y1);
    ctx.fillText("MEMPOOL SIZE", this.x1, 11*this.y1);
    ctx.fillText("MEMPOOL SIZE", this.x2, 11*this.y1);
    ctx.fillText("MEMPOOL FEES", this.x1, 13*this.y1);
    ctx.fillText("MEMPOOL FEES", this.x2, 13*this.y1);
    ctx.fillText("MEMPOOL COST", this.x1, 15*this.y1);
    ctx.fillText("MEMPOOL COST", this.x2, 15*this.y1);
    ctx.fillText("TOTAL NETSPACE", this.x1, 17*this.y1);
    ctx.fillText("TOTAL NETSPACE", this.x2, 17*this.y1);
    //ctx.fillStyle = "lime";
    ctx.fillStyle = "HSL(" + 15 + this.hue % 360 + ",100%,50%)";
    ctx.fillText(numberWithSpaces(BLOCK.height1), this.x1 + bh_text, 3*this.y1);
    ctx.fillText(numberWithSpaces(BLOCK.height2), this.x2 + bh_text, 3*this.y1);
    ctx.fillText(BLOCK.spi1, this.x1 + spi_text, 5*this.y1);
    ctx.fillText(BLOCK.spi2, this.x2 + spi_text, 5*this.y1);
    ctx.fillText(BLOCK.abt1, this.x1 + abt_text, 7*this.y1);
    ctx.fillText(BLOCK.abt2, this.x2 + abt_text, 7*this.y1);
    ctx.fillText(numberWithSpaces(BLOCK.dif1), this.x1 + dif_text, 9*this.y1);
    ctx.fillText(numberWithSpaces(BLOCK.dif2), this.x2 + dif_text, 9*this.y1);
    ctx.fillText(BLOCK.msize1, this.x1 + mem_text, 11*this.y1);
    ctx.fillText(BLOCK.msize2, this.x2 + mem_text, 11*this.y1);
    ctx.fillText(numberWithSpaces(BLOCK.mfees1), this.x1 + mem_text, 13*this.y1);
    ctx.fillText(numberWithSpaces(BLOCK.mfees2), this.x2 + mem_text, 13*this.y1);
    ctx.fillText(numberWithSpaces(BLOCK.mcost1), this.x1 + mem_text, 15*this.y1);
    ctx.fillText(numberWithSpaces(BLOCK.mcost2), this.x2 + mem_text, 15*this.y1);
    ctx.fillText(truncateDecimals(BLOCK.space1/1000000000000000000, 5) + " EB", this.x1 + space_text, 17*this.y1);
    ctx.fillText(truncateDecimals(BLOCK.space2/1000000000000000000, 5) + " EB", this.x2 + space_text, 17*this.y1);
  },
};

ctx.clearRect(0, 0, canvas.width, canvas.height);
ctx.fillStyle = "black";
ctx.fillRect(0, 0, canvas.width, canvas.height);

var span;

if ( w > h ) {
    ctx.font = Math.round(4*h/100) + "px led";
    span = 4*h/100 * 13/16;
    console.log(span);
} else {
    ctx.font = Math.round(4*w/100) + "px led";
    span = 4*w/100 * 13/16;
    console.log(span);
}

let bh_text = 12*span;
let spi_text = 19*span;
let abt_text = 18*span;
let dif_text = 11*span;
let mem_text = 13*span;
let space_text = 15*span;

/*let bh_text = ctx.measureText("BLOCK_HEIGHT_")
let spi_text = ctx.measureText("SIGNAGE_POINT_INDEX_")
let abt_text = ctx.measureText("AVERAGE_BLOCK_TIME_")
let dif_text = ctx.measureText("DIFFICULTY_")
let mem_text = ctx.measureText("MEMPOOL_SIZE_")
let space_text = ctx.measureText("TOTAL_NETSPACE_")
*/
blockchain_state();

const ws = new WebSocket('wss://api.coinset.org/ws');
ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  switch (message.type) {
    case 'offer':
      //console.log('New offer:', message.data.offer);
      break;
    case 'peak':
      console.log('New block height:', message.data.height);
      blockchain_state();
      break;
    case 'transaction':
      //console.log('New transaction:', message.data.id);
      break;
  }
};

    </script>
</body>

</html>
